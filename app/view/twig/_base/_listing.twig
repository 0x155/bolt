{% import '@bolt/_macro/_macro.twig' as macro %}
{% import '@bolt/_macro/_buic.twig' as buic %}

{% set modifiable = permissions.create or permissions.edit or permissions.delete or permissions.publish or permissions.depublish %}

{% set prop = {
    extended:       not compact,
    has_groupname:  content.group.name is defined,
    nextgroup:      new_group|default(false),
    unordered:      request('order') == '',
    first:          loop.first
}%}

{#
 # GROUPNAME: If we have 'grouping', print the row with the groupname.
 #}
{% if prop.extended and prop.has_groupname and (prop.first or prop.nextgroup) and prop.unordered %}
    {% if not prop.first %}</tbody>{% endif %}
    <tbody {% if modifiable %}class="sortable"{% endif %}>
    <tr class="grouping">
        <th colspan="{% block listing_columns %}6{% endblock %}">
            <h3 {% if prop.first %}class="first"{% endif %}>
                {{ content.group.name|default(__('(no group)')) }}
            </h3>
        </th>
    </tr>
{% endif %}

{#
 # HEADER ROW: Print the header for the first row.
 #}
{% if prop.extended and (prop.first or (prop.has_groupname and prop.nextgroup) and prop.unordered) %}
    {% if 'filter' in app.request.query.all|keys %}
        {% set filter = 'filter=' ~ app.request.query.all.filter ~ '&' %}
    {% else %}
        {% set filter = '' %}
    {% endif %}

    <tr>
        {% set link = '?' ~ filter ~ 'order=' %}

        {% block listing_header %}
            {% set column_title = content.TitleColumnName()|first %}
            {% set href = {
                content: link ~ (request('order') == column_title  ? '-' : '') ~ column_title,
                meta:    link ~ (request('order') == 'datecreated' ? '-' : '') ~ 'datecreated',
                id:      link ~ (request('order') == 'id'          ? '-' : '') ~ 'id'
            }%}

            {# COLUMN: Select #}
            {% if prop.extended and modifiable %}
                <th class="check hidden-xs"><input type="checkbox" name="checkRow" title="{{ __('Select all') }}" /></th>
            {% else %}
                <th style="margin: 0; padding: 0;"></th>
            {% endif %}

            {# COLUMN: ID #}
            <th class="hidden-xs">
                <a href="{{ href.id }}">{{ __('Id') }}</a>
            </th>

            {# COLUMN: Content #}
            <th style="width:80%">
                <a href="{{ href.content }}">{{ __('Title') }} / {{ __('Excerpt') }}</a>
            </th>

            {# COLUMN: Thumbnail #}
            <th>&nbsp;</th>

            {# COLUMN: Meta #}
            <th class="username hidden-xs">
                <a href="{{ href.meta }}">{{ __('Meta') }}</a>
            </th>

            {# COLUMN: Action #}
            <th>
                <a href="?">{{ __('Actions') }}</a>
            </th>
        {% endblock %}
    </tr>
{% endif %}

{#
 # DATA ROW
 #}
<tr {% if content.status!='published' %}class="dim"{% endif %}{% if prop.extended and modifiable %} id="item_{{ content.id }}"{% endif %}>

    {### BLOCK: ID ###}
    {% block listing_id %}
        {# COLUMN: Select #}
        {% if prop.extended and permissions.delete %}
            <td class="check hidden-xs"><input type="checkbox" name="checkRow"></td>
        {% else %}
            <td style="margin: 0; padding: 0;"></td>
        {% endif %}

        {# COLUMN: ID #}
        <td class="id hidden-xs">№ {{ content.id }}</td>
    {% endblock %}

    {### BLOCK: CONTENT ###}
    {% block listing_content %}
        {# COLUMN: Content #}
        <td class="excerpt {% if prop.extended %}large{% endif %}">
            {% set title = content.getTitle|default("<em>(" ~ __("no title …") ~ ")</em>")|raw %}
            <span>
                <strong class="visible-xs">№ {{ content.id }}. </strong>
                <strong>
                    {% if modifiable %}
                        <a href="{{ path('editcontent', {'contenttypeslug': content.contenttype.slug, 'id': content.id}) }}" title="Slug: {{ content.slug }}">
                            {{ title }}
                        </a>
                    {% else %}
                        <strong>
                            {{ title }}
                        </strong>
                     {% endif %}
                </strong>
                {{ content.excerpt(excerptlength - title|length) }}
            </span>
        </td>

        {# COLUMN: Thumbnail #}
        <td class="listthumb">
            {% if content.getImage is not empty %}
                {# Hack to add alt attribute #}
                {#{ content.getImage|popup(thumbsize, thumbsize * 0.75, 'c') }#}
                {% set thumb_height = (thumbsize * 0.75)|round %}
                {% set thumb_small = content.getImage|thumbnail(thumbsize, thumb_height, 'c') %}
                {% set thumb_large = content.getImage|thumbnail(1000, 800, 'r') %}
                {% set thumb_title = __('Image') ~ ': ' ~ content.getImage %}
                <a href="{{ thumb_large }}" class="magnific" title="{{ thumb_title }}">
                    <img src="{{ thumb_small }}" width="{{ thumbsize }}" height="{{ thumb_height }}" alt="{{ __('Thumbnail') }}">
                </a>
            {% endif %}
        </td>
    {% endblock %}

    {% if prop.extended %}
        {% block listing_meta %}
            {# COLUMN: Meta #}
            <td class="username hidden-xs">
                <i class="fa fa-user fa-fw"></i>
                {% if content.user.displayname is defined %}
                    {{ content.user.displayname|trimtext(15) }}
                {% else %}
                    <s>{{ content.values.ownerid|trimtext(15) }}</s>
                {% endif %}<br>
                {% if content.status == 'timed' %}
                    <i class="fa fa-clock-o status-timed fa-fw"></i> {{ buic.moment(content.datepublish) }}<br>
                {% else %}
                    <i class="fa fa-circle status-{{ content.status }} fa-fw"></i> {{ content.datepublish|localdate('%x') }}<br>
                {% endif %}
                {% if content.sortorder|default() is not empty %}
                    <i class="fa fa-sort fa-fw"></i> {{ __('Order: %sort%',{'%sort%': content.sortorder}) }}<br>
                {% endif %}
            </td>
        {% endblock %}
    {% endif %}

    {### BLOCK: ACTIONS ###}
    {% block listing_actions %}
        {# COLUMN: Action #}
        <td class="actions">
            <div class="btn-group">
                {% if modifiable %}
                    <a class="btn btn-default btn-xs" href="{{ path('editcontent', {'contenttypeslug': content.contenttype.slug, 'id': content.id}) }}">
                        <i class="fa fa-edit"></i> {{ __('Edit') }}
                    </a>
                {% endif %}
                <button type="button" class="btn btn-default dropdown-toggle btn-xs" data-toggle="dropdown">
                    <i class="fa fa-info-sign"></i> <span class="caret"></span>
                </button>

                <ul class="dropdown-menu pull-right">
                    {% if content.status == "published" and content.link is defined %}
                        <li>
                            <a href="{{ content.link }}" target="_blank">
                                <i class="fa fa-external-link-square"></i> {{ __('View on site') }}
                            </a>
                        </li>
                    {% endif %}
                    {% if content.relation %}{# i.e. we're viewing this as "related content" on the "edit record" page. #}
                        <li>
                            <a href="{{ path('relatedto', {'contenttypeslug': content.contenttype.slug, 'id': content.id}) }}">
                                <i class="fa fa-link"></i> {{ __('View related content') }}
                            </a>
                        </li>
                    {% endif %}

                    {% from _self import actionform %}
                    {% if modifiable %}
                        {% if content.status != 'published' %}
                            {% if permissions.publish %}
                            <li>{{ macro.actionform(content, 'publish', 'fa-circle status-published', __('contenttypes.generic.publish',{'%contenttype%':content.contenttype.slug})) }}</li>
                            {% endif %}
                        {% else %}
                            {% if permissions.depublish %}
                            <li>{{ macro.actionform(content, 'held', 'fa-circle status-held', __("Change status to 'held'")) }}</li>
                            <li>{{ macro.actionform(content, 'draft', 'fa-circle status-draft', __("Change status to 'draft'")) }}</li>

                            {% endif %}
                        {% endif %}
                        {% if permissions.create %}
                            <li>
                                <a href="{{ path('editcontent', {'contenttypeslug': content.contenttype.slug, 'id': content.id, 'duplicate': 1}) }}">
                                    <i class="fa fa-copy"></i> {{ __('contenttypes.generic.duplicate', {'%contenttype%': content.contenttype.slug}) }}
                                </a>
                            </li>
                        {% endif %}
                        {% if permissions.delete %}
                            <li>
                                {{ macro.actionform(content, 'delete',
                                                  'fa-trash',
                                                  __('contenttypes.generic.delete', {'%contenttype%': content.contenttype.slug}),
                                                  "Are you sure you want to delete '" ~ content.getTitle ~ "'?" ) }}
                            </li>
                        {% endif %}
                        <li class="divider"></li>
                    {% endif %}
                    <li>
                        <a class="nolink">
                            {{ __('Author:') }} <strong><i class="fa fa-user"></i>
                            {% if content.user.displayname is defined %}
                                {{ content.user.displayname|trimtext(15) }}
                            {% else %}
                                <s>user {{ content.values.ownerid }}</s>
                            {% endif %}</strong>
                        </a>
                    </li>
                    <li>
                        <a class="nolink">{{ __('Current status:') }}<strong>{{ content.status }}</strong></a>
                    </li>
                    <li>
                        <a class="nolink">{{ __('Slug:') }}
                            <code title="{{ content.slug }}">{{ content.slug|trimtext(24) }}</code>
                        </a>
                    </li>
                    <li>
                        <a class="nolink">{{ __('Created on:') }}
                            <i class="fa fa-asterisk"></i> {{ content.datecreated|date("Y-m-d H:i") }}
                        </a>
                    </li>
                    <li>
                        <a class="nolink">{{ __('Published on:') }}
                            <i class="fa fa-calendar"></i> {{ content.datepublish|date("Y-m-d H:i") }}
                        </a>
                    </li>
                    <li>
                        <a class="nolink">{{ __('Last edited on:') }}
                            <i class="fa fa-refresh"></i> {{ content.datechanged|date("Y-m-d H:i") }}
                        </a>
                    </li>
                    {% for taxonomyslug, values in content.taxonomy %}
                        {% if values|length > 1 %}
                            <li>
                                <a class="nolink">{{ config.get('taxonomy')[taxonomyslug].name }}:
                                    <i class="fa fa-tag"></i> {{ values|join(", ")|trimtext(24) }}
                                </a>
                            </li>
                        {% else %}
                            <li>
                                <a class="nolink">{{ config.get('taxonomy')[taxonomyslug].singular_name }}:
                                    <i class="fa fa-tag"></i> {{ values|first|trimtext(24) }}
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
        </td>
    {% endblock %}
</tr>
