<div class="panel panel-default">
    <div class="panel-heading">
        <i class="fa fa-cog fa-fw"></i> {{ __('Actions for this %contenttype%',{'%contenttype%': context.contenttype.singular_name}) }}
    </div>

    <div class="panel-body">

        <div class="btn-group">
            <button type="button" class="btn btn-primary" id="sidebarsavecontinuebutton">
                <i class="fa fa-flag"></i> {{  __('Save %contenttype%',{'%contenttype%': context.contenttype.singular_name}) }}
            </button>
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" role="menu">
                <li>
                    <button type="submit" class="btn btn-link" id="sidebarsavebutton">
                        <i class="fa fa-flag"></i> {{ __('Save & return to overview') }}
                    </button>
                </li>
                <li>
                    <button type="submit" class="btn btn-link" id="sidebarsavenewbutton">
                        <i class="fa fa-flag"></i> {{ __('Save & create new record') }}
                    </button>
                </li>
            </ul>
        </div>

        <div class="btn-group">
            <button type="button" class="btn btn-default" id="sidebarpreviewbutton">
                <i class="fa fa-external-link-square"></i> {{ __('Preview') }}
            </button>
            {% if context.content.status == "published" and context.content.link is defined %}
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    <span class="caret"></span>
                    <span class="sr-only">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu pull-right" role="menu">
                    <li>
                        <a href="{{ context.content.link }}" target="_blank">
                            <i class="fa fa-external-link-square"></i> {{ __('View (saved version) on site') }}</a></li>
                        </a>
                    </li>
                </ul>
            {% endif %}
        </div>

        <p>
            {{ __("Current (saved) status:") }}
            <a href="#statusselect" data-action="$('#statusselect').focus();" id="lastsavedstatus" title="{{ __("Click to change current status.") }}">
                <strong>
                    <i class="fa fa-circle status-{{ context.content.status|default(__("none")) }}"></i>
                    {{ status_names[context.content.status]|default(__("None")) }}
                </strong>
            </a>
        </p>

        <p class="lastsaved">
            {% if context.content.id != 0 %}
            {{ __('Saved on:') }} <strong>{{ context.content.datechanged|localdate("%b %e, %H:%M") }}</strong> <small>({{ macro.datetime(context.content.datechanged) }})</small></p>
        {% else %}
            {{ __('This %contenttype% has not been saved yet.', {'%contenttype%': context.contenttype.singular_name}) }}
        {% endif %}
        </p>
    </div>
</div>


<script type="text/javascript">
    $(function() {

        // Save the page..
        $('#sidebarsavebutton').bind('click', function(e){
            $('#savebutton').trigger('click');
        });
        $('#savebutton').bind('click', function(e){

            // Re-set the changes to the form..
            $('form').watchChanges();

        });

        // Handle "save and new".
        $('#sidebarsavenewbutton, #savenewbutton').bind('click', function(e){

            // Re-set the changes to the form..
            $('form').watchChanges();

            // Do a regular post, and expect to be redirected back to the "new record" page.
            var newaction = "?returnto=new";
            $('#editcontent').attr('action', newaction).submit();

        });

        // Clicking the 'save & continue' button either triggers an 'ajaxy' post, or a regular
        // post which returns to this page. The latter happens if the record doesn't exist yet, so it doesn't
        // have an id yet.
        $('#sidebarsavecontinuebutton, #savecontinuebutton').bind('click', function(e){
            e.preventDefault();

            var newrecord = {% if context.content.id != 0 %}false{% else %}true{% endif %};

            // Disable the buttons, to indicate stuff is being done.
            $('#sidebarsavecontinuebutton, #savecontinuebutton').addClass('disabled');

            $('p.lastsaved').text('{{ __("Savingâ€¦") }}');

            if (newrecord) {

                // Re-set the changes to the form..
                $('form').watchChanges();

                // New record.. do a regular post, and expect to be redirected back to this page.
                var newaction = "?returnto=" + $(this).attr('id');
                $('#editcontent').attr('action', newaction).submit();
            } else {
                // Existing record. Do an 'ajaxy' post to update the record.

                // Re-set the changes to the form..
                $('form').watchChanges();

                $.post("", $( "#editcontent" ).serialize() )
                    .done(function(data) {
                        // var message = "{{ __('The changes to this %contenttype% have been saved.', {'%contenttype%': context.contenttype.singular_name}) }}";
                        $('p.lastsaved').html('{{ __('Saved on:') }} <strong></strong> <small>({{ macro.datetime(context.content.datechanged) }})</small></p>');
                        $('p.lastsaved').find('strong').text(moment().format('MMM D, HH:mm'));
                        $('p.lastsaved').find('time').attr('datetime', moment().format());
                        $('p.lastsaved').find('time').attr('title', moment().format());
                        updateMoments();

                        $('a#lastsavedstatus strong').html(
                            '<i class="fa fa-circle status-' + $("#statusselect option:selected").val() + '"></i> ' +
                            $("#statusselect option:selected").text()
                        );

                    })
                    .fail(function(){
                        $('p.lastsaved').text('{{ __('Could not save %contenttype%.', { '%contenttype%': context.contenttype.singular_name }) }}');
                    })
                    .always(function(){
                        // Re-enable buttons
                        $('#sidebarsavecontinuebutton, #savecontinuebutton').removeClass('disabled');
                    });
            }

        });

        // To preview the page, we set the target of the form to a new URL, and open it in a new window.
        $('#previewbutton, #sidebarpreviewbutton').bind('click', function(e){

            e.preventDefault();
            var newaction = "{{ paths.root }}" + "preview" + "/{{ context.contenttype.singular_slug }}";
            $('#editcontent').attr('action', newaction).attr('target', "_blank").submit();
            $('#editcontent').attr('action', '').attr('target', "_self");

        });

    });
</script>

{{ render(path("lastmodified", {"contenttypeslug": context.contenttype.slug, "contentid": context.content.id} )) }}

{{ render(path("showstack", {'items': 5, 'options': 'full' } )) }}
