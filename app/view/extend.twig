{% include '_header.twig' with { 'active':'extend' } %}

<div class='extend-bolt-container'>
{% block extendmessages %}
    {% if messages %}
        <div class="alert alert-info">
            <button class="close" data-dismiss="alert">Ã—</button>
            {% for message in messages %}
                {{message}}
            {% endfor %}
        </div>
    {% endif %}
{% endblock %}

<div class="row-fluid">
    <div class="span8">
        <div class='update-check-container hide'>
            <h3>Updates</h3>
            <pre class="update-check console">Checking for available updates (this may take up to 60 seconds)..</pre>
        </div>
        <section class="installed-container">
            <h3>Your Currently Installed Extensions</h3>
            <pre class="installed console" data-action='installed'>Checking installed packages..</pre>
            <div class="installed-list hide"></div>
        </section>
        <hr />
        <section>
            <h3>Install a new Extension</h3>
            <p>
                Add a new extension using the form below. You can discover new extensions by visiting 
                <a href="{{site}}">{{site}}</a>
            </p>
            <div class="install-container">
                
                    <input type="text" name="check-package" placeholder="Extension name eg: bolt/widget">
                    <a class="btn check-package">
                        <i class="icon-gears"></i> Check Extension
                    </a> 
            </div>
            <div class='install-response-container hide'>
                <h3>Installing package</h3>
                <pre class="install-response console">Installing selected package version (this may take up to 60 seconds).</pre>
            </div>
        </section>
    </div>
    
    <aside class="span4">
        <h2>Options</h2>
        <section>
        <h4>Check for updates</h4>
            <a class="btn" data-trigger="check" data-target='update-check' data-show="update-check-container">
                <i class="icon-refresh"></i> Run update check
            </a>
        <h4>Install all updates</h4>
            <a class="btn btn-primary" data-trigger="update" data-target='update-run' data-show="update-run-container">
                <i class="icon-refresh"></i> Install all Updates
            </a>
        </section>
    </aside>
    
</div>

</aside>

<script>
    var site = '{{site}}';
    var baseurl = "/bolt/extend/";
    jQuery(document).ready(function($) {
        
        var active_console;
        var active_interval;
        
        $(document).ajaxStart(function() {
            // show loader on start
            active_interval = setInterval(function(){
                active_console.append(".");
            },1000);
        }).ajaxSuccess(function() {
            clearInterval(active_interval);
        });
        
        
        
        $('.extend-bolt-container').find('.installed-container').each(function(){
            active_console = $(this).find(".console");
            var target = $(this).find('.installed-list');
            $.get(baseurl+"installed", function(data) {
                target.show();
                if(typeof(data)=="string") {
                    target.html(data).wrapInner('<h4>');
                    active_console.hide();
                } else {
                    console.log(data);
                }
            });
        });
        
        $('.extend-bolt-container').find('[data-trigger]').each(function(){
            $(this).on('click', function(){
                $("." + $(this).data('show') ).show();
                var target = $("." + $(this).data('target') );
                active_console = target;
                $.get('/bolt/extend/'+$(this).data('trigger'), function(data) {
                    target.html(data);
                });
            });
            
        });
        
        
        $('.check-package').on('click', function(){
            var ext = $('input[name="check-package"]').val();
            active_console = $(".check-package");
            $.ajax({
                url: site+'list.json',
                dataType: 'jsonp',
                data: {'name': ext},
            })
            .success(function(data) {
                var pack = data.packages[0];
                var tpl = '';
                tpl+='<input type="hidden" name="package-name" value="'+pack.name+'">'
                tpl+='<label>Select Version To Install</label><select name="package-version">';
                for(var v in pack.versions) {
                    tpl+='<option value="'+pack.versions[v]+'">'+pack.versions[v]+'</option>'
                }
                tpl +='</select><a class="btn install-package"><i class="icon-gears"></i> Install Extension</a>';
                $(".check-package").replaceWith(tpl);
            })
            .fail(function() {
                alert('Bolt Extension could not be found. Please check at {{site}} to ensure correct name.')
            })
            .always(function() {

            });
            
        
        });
        
        $('.install-container').on('click', '.install-package', function(){
            var package = $('input[name="package-name"]').val();
            var version = $('select[name="package-version"]').val();
            $('.install-response-container').show();
            active_console = $('.install-response-container .console');
            $.get('/bolt/extend/install', {'package':package,'version':version}, function(data) {
                $('.install-response-container .console').html(data);
            });
        });
        
    });
</script>

{% include '_footer.twig' %}
