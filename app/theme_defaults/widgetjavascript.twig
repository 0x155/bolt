{% spaceless %}
<script>
/*<![CDATA[*/

document.addEventListener("DOMContentLoaded", function(event) {

    var widgets = document.querySelectorAll('div.widget');

    for(i = 0; i < widgets.length; i++) {
        if (widgets[i].getAttribute('data-defer') === 'true') {
            var key = widgets[i].getAttribute('data-key');

            var request = new XMLHttpRequest();
            request.open('GET', '{{ paths.async }}widget/' + key, true);

            request.onload = function() {
                if (this.status >= 200 && this.status < 400) {
                    var widget = document.querySelectorAll('div#widget-' + this.responseURL.replace(/^.*\/|\.*$/g, ''));
                    widget[0].innerHTML = this.response;
                } else {
                    console.log('Failed to get widget. Status: ' + this.status);
                }
            };

            request.onerror = function() {
                console.log('Failed to get widget. Connection error.');
            };

            request.send();
        }
    };

});

/*]]>*/
</script>
{% endspaceless %}